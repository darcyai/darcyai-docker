parameters:
  - name: imageName
    type: string
  - name: imageTag
    type: string
  - name: dockerFile
    type: string
  - name: step
    type: string

steps:
  - task: Docker@2
    displayName: Login to Dockerhub
    inputs:
      command: login
      containerRegistry: DarcyAI-Dockerhub

  - script: |
      docker buildx create --name darcyai-builder
      docker buildx use darcyai-builder
    displayName: 'Setup docker buildx builder'

  - script: |
      docker buildx build -t ${{ parameters.imageName }}:${{ parameters.imageTag }} \
        --platform linux/amd64,linux/arm64,linux/arm/v7 \
        --build-arg BASE_IMAGE_TAG=${{ parameters.imageTag }} \
        --file ${{ parameters.dockerFile }} .
    displayName: 'Build and push ${{ parameters.step }} images'
